---
layout: post
title: Implementing a @Serializable annotation with Groovy AST transformations
categories:
- ast transformations
- grails
- groovy
tags: []
status: publish
type: post
published: true
meta:
  blogger_d263388631120bb7ee0fc300fe57c4e6_permalink: '7604493040193044615'
  reddit: s:55:"a:2:{s:5:"count";s:1:"0";s:4:"time";s:10:"1293719833";}";
  _edit_lock: '1295332120'
  blogger_author: Andre Steingress
  blogger_blog: grails-inside.blogspot.com
  _flattr_post_language: ''
  _flattr_post_category: ''
  _flattr_post_hidden: ''
  _flattr_btn_disabled: ''
---
Groovy 1.6 provides hooks to intercept the compilation process and modify the generated AST (abstract syntax tree).<br /><br />There are two categories of AST transformations:<br /><ul><li>global transformations&nbsp;</li><li>local transformations</li></ul><div>This blog-post deals with local transformations. A local AST transformation is usually done in three steps:</div><div><br /></div><div><ol><li>you have to implement an annotation that marks a code fragement for AST transformation. the chosen code fragement depends on you transformation's functionality. In my case, i just wanted a <span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@Serializable</span> annotation instead of using Java's <span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">java.io.Serializable</span> interface, so that <span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@Serializable</span> annotation is ment to be applied at <span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">ElementType.TYPE</span> level. If your use-case is a different one, of course you could choose other element-type levels.</li><li>you actually have to implement the AST transformation. this is done by implementing the <span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">org.codehaus.groovy.transform.ASTTransformation</span> interface.</li><li>you have to wire your custom annotation with your AST transformation implementation of step 2. this is done by using the <span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@GroovyASTTransformationClass</span> annotation (a meta-annotation) with the complete path to your ast-transformation class.</li></ol><div><br /></div><div>In the end, applying the <span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@Serializable</span> annotation is as simple as specifying the annotation on some Groovy class</div><div><br /></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@Serializable</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">class User {</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp;// ...</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">}</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;">The implementation of step 1) is just a simple annotation declaration</span></div><div><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;"><br /></span></div><div><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;"><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@Retention(RetentionPolicy.SOURCE)</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@Target(ElementType.TYPE)</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@GroovyASTTransformationClass("org.nlr.annotations.SerializableASTTransformation")</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">public @interface Serializable {</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">}</span></div></span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;">and the transformation code is as simple as</span></div><div><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;"><br /></span></div><div><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;"><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">@GroovyASTTransformation(phase= CompilePhase.SEMANTIC_ANALYSIS)</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">public class SerializableASTTransformation implements ASTTransformation {</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp;public void visit(ASTNode[] nodes, SourceUnit source) {</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;if (!(nodes[0] instanceof AnnotationNode) || !(nodes[1] instanceof AnnotatedNode)) {</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;throw new RuntimeException("Internal error: wrong types: $node.class / $parent.class");</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;}</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;AnnotatedNode parent = (AnnotatedNode) nodes[1];</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;AnnotationNode node = (AnnotationNode) nodes[0];</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;if (parent instanceof ClassNode) {</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ClassNode classNode = (ClassNode) parent;</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;classNode.addInterface(ClassHelper.make(java.io.Serializable.class));</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;}</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp;}</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">}</span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><br /></span></div><div>Notice, that the specified compile phase is "semantic analysis" - a property of local transformations is that they can only be applied in "semantic analysis" compilation phase or above.</div><div><br /></div><div>If you take a look at the generated (disassembled) byte-code you'll see that the User class's byte-code now implements <span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;">java.io.Serializable</span>.<br /><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family:'Courier New', Courier, monospace;"><div>public class org.nlr.domain.User extends java.lang.Object implements java.io.Serializable,groovy.lang.GroovyObject{</div><div>&nbsp;&nbsp; &nbsp;public static final java.lang.Class $ownClass;</div><div>&nbsp;&nbsp; &nbsp;java.lang.Long id;</div><div>&nbsp;&nbsp; &nbsp;java.lang.Long version;</div><div>&nbsp;&nbsp; &nbsp;java.util.Set registrations;</
div><div>&nbsp;&nbsp; &nbsp;...<br /><br /></div></span></div></span></div></div><div><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;">[0]&nbsp;<a href="http://groovy.codehaus.org/Local+AST+Transformations">http://groovy.codehaus.org/Local+AST+Transformations</a></span></div><div><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;">[1]&nbsp;<a href="http://groovy.codehaus.org/Global+AST+Transformations">http://groovy.codehaus.org/Global+AST+Transformations</a></span><br /><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;"><br /></span><br /><span class="Apple-style-span" style="font-family:Times, 'Times New Roman', serif;"><br /></span></div>
